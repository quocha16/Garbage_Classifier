<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Garbage Classifier</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #10b981;
            --primary-dark: #059669;
            --bg-color: #f0fdf4;
            --card-bg: #ffffff;
            --text-main: #1f2937;
            --text-sub: #6b7280;
            --border-color: #e5e7eb;
            --input-bg: #f9fafb;
            --shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.1);
            --tag-blue-bg: #e0f2fe;
            --tag-blue-text: #0284c7;
            --tag-green-bg: #dcfce7;
            --tag-green-text: #10b981;
            --tag-red-bg: #fee2e2;
            --tag-red-text: #ef4444;
            --tag-yellow-bg: #fef3c7;
            --tag-yellow-text: #f59e0b;
        }

        [data-theme="dark"] {
            --bg-color: #111827;
            --card-bg: #1f2937;
            --text-main: #f9fafb;
            --text-sub: #9ca3af;
            --border-color: #374151;
            --input-bg: #374151;
            --shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.5);
            --tag-blue-bg: #0c4a6e;
            --tag-blue-text: #38bdf8;
            --tag-green-bg: #064e3b;
            --tag-green-text: #34d399;
            --tag-red-bg: #7f1d1d;
            --tag-red-text: #f87171;
            --tag-yellow-bg: #78350f;
            --tag-yellow-text: #fbbf24;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .app-container {
            width: 100%;
            max-width: 1000px;
            position: relative;
        }

        .theme-toggle {
            position: absolute;
            top: 0;
            right: 0;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-main);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow);
            font-size: 1.2rem;
            z-index: 10;
        }

        /* --- STYLE CHO NÚT INFO MỚI --- */
        .info-toggle {
            position: absolute;
            top: 55px; /* Nằm dưới nút theme (40px + 15px gap) */
            right: 0;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--tag-blue-text); /* Màu xanh cho nổi bật */
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow);
            font-size: 1.1rem;
            z-index: 10;
        }

        .info-toggle:hover {
            transform: scale(1.1);
            background: var(--border-color);
        }

        /* --- STYLE CHO MODAL INFO --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: var(--card-bg);
            margin: 15% auto;
            padding: 30px;
            border: 1px solid var(--border-color);
            width: 90%;
            max-width: 500px;
            border-radius: 16px;
            position: relative;
            box-shadow: var(--shadow);
            color: var(--text-main);
        }

        .close-btn {
            color: var(--text-sub);
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-btn:hover {
            color: var(--primary);
        }
        /* --------------------------- */

        header {
            text-align: center;
            margin-bottom: 40px;
        }

        header h1 {
            color: var(--primary);
            font-size: 2.5rem;
            margin-bottom: 5px;
        }

        header p {
            color: var(--text-sub);
            font-size: 0.9rem;
        }

        .main-layout {
            display: flex;
            justify-content: center;
            gap: 25px;
            transition: all 0.5s ease;
        }

        .upload-panel {
            width: 100%;
            max-width: 500px;
        }

        .main-layout.has-results {
            display: grid;
            grid-template-columns: 1fr 1.3fr;
        }

        .panel {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 30px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border-color);
        }

        .upload-area {
            flex: 1;
            border: 3px dashed var(--border-color);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            cursor: pointer;
            background: var(--input-bg);
            min-height: 350px;
            margin-bottom: 25px;
            position: relative;
            overflow: hidden;
            transition: 0.3s;
        }

        .upload-area:hover,
        .upload-area.drag-active {
            border-color: var(--primary);
            background: rgba(16, 185, 129, 0.1);
        }

        .placeholder-view {
            text-align: center;
            color: var(--text-sub);
            transition: 0.3s;
        }

        #imagePreview {
            width: 100%;
            height: 100%;
            object-fit: contain;
            position: absolute;
            top: 0;
            left: 0;
            display: none;
        }

        .upload-area.has-image .placeholder-view {
            opacity: 0;
        }

        .upload-area.has-image #imagePreview {
            display: block;
        }

        .btn-primary {
            background: var(--primary);
            color: #fff;
            border: none;
            padding: 16px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-primary:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .info-panel {
            display: none;
            opacity: 0;
            transform: translateX(20px);
            transition: all 0.5s ease;
        }

        .model-selection {
            margin-bottom: 20px;
            background: var(--input-bg);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .model-label {
            font-size: 0.85rem;
            color: var(--text-sub);
            margin-bottom: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .switch-container {
            display: flex;
            gap: 10px;
        }

        .switch-container input[type="radio"] {
            display: none; /* Ẩn nút radio mặc định */
        }

        .switch-btn {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            background: var(--card-bg);
            color: var(--text-sub);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .switch-btn:hover {
            background: var(--border-color);
        }

        /* Hiệu ứng khi được chọn */
        input[type="radio"]:checked + .switch-btn {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3);
        }

        .main-layout.has-results .info-panel {
            display: flex;
            opacity: 1;
            transform: translateX(0);
        }

        .result-header {
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .garbage-name {
            font-size: 2.2rem;
            color: var(--text-main);
            text-transform: uppercase;
        }

        .prob-container {
            margin-bottom: 25px;
            padding: 15px;
            background: var(--input-bg);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .prob-container h3 {
            font-size: 0.85rem;
            margin-bottom: 12px;
            text-transform: uppercase;
            color: var(--text-sub);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .prob-item {
            margin-bottom: 10px;
            cursor: pointer;
            padding: 5px;
            border-radius: 8px;
            transition: 0.2s;
        }

        .prob-item:hover {
            background: var(--border-color);
        }

        .prob-item.active {
            border-left: 4px solid var(--primary);
            background: rgba(20, 223, 158, 0.3);
        }

        .prob-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            margin-bottom: 4px;
            font-weight: 700;
        }

        .prob-bar-bg {
            background: var(--border-color);
            height: 8px;
            border-radius: 10px;
            overflow: hidden;
        }

        .prob-bar-fill {
            background: var(--primary);
            height: 100%;
            width: 0;
            transition: width 1s ease-out;
        }

        .properties-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .prop-card {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 12px;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
        }

        .icon-box {
            width: 38px;
            height: 38px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .text-box {
            display: flex;
            flex-direction: column;
        }

        .text-box .label {
            font-size: 0.65rem;
            color: var(--text-sub);
            text-transform: uppercase;
        }

        .text-box .value {
            font-weight: 700;
            font-size: 0.85rem;
        }

        .inorganic .icon-box {
            background: var(--tag-blue-bg);
            color: var(--tag-blue-text);
        }

        .recyclable .icon-box {
            background: var(--tag-green-bg);
            color: var(--tag-green-text);
        }

        .flammable .icon-box {
            background: var(--tag-red-bg);
            color: var(--tag-red-text);
        }

        .time .icon-box {
            background: var(--tag-yellow-bg);
            color: var(--tag-yellow-text);
        }

        .disposal-guide {
            background: rgba(16, 185, 129, 0.1);
            padding: 18px;
            border-radius: 12px;
            border-left: 5px solid var(--primary);
        }

        .disposal-guide h3 {
            font-size: 1rem;
            margin-bottom: 8px;
            color: var(--primary);
        }

        .disposal-guide ul {
            padding-left: 18px;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        @media (max-width: 768px) {
            .main-layout.has-results {
                grid-template-columns: 1fr;
            }

            .properties-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>

    <div class="app-container">
        <button class="theme-toggle" id="themeBtn"><i class="fas fa-moon"></i></button>

        <button class="info-toggle" id="infoBtn" title="About Project"><i class="fas fa-info"></i></button>

        <header>
            <h1><i class="fas fa-recycle"></i> Waste Classifier</h1>
            <p>
                <strong>Created by: アイン・クオック</strong>
            </p>
        </header>
        <main class="main-layout" id="mainLayout">
            <section class="panel upload-panel">
                <div class="upload-area" id="uploadArea">
                    <div class="placeholder-view">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 3.5rem; opacity: 0.3; margin-bottom: 10px;"></i>
                        <h3>Click or Drag & Drop</h3>
                        <p>JPG, PNG, JPEG</p>
                    </div>
                    <img id="imagePreview" src="#">
                </div>
                <input type="file" id="fileInput" accept="image/*" hidden>
                <div class="model-selection">
                    <p class="model-label">Select Model:</p>
                    <div class="switch-container">
                        <input type="radio" name="ai-model" id="mod_svm" value="svm" checked>
                        <label for="mod_svm" class="switch-btn"> Classical SVM
                        </label>
                        <input type="radio" name="ai-model" id="mod_net" value="net">
                        <label for="mod_net" class="switch-btn"> Neural Net
                        </label>
                    </div>
                </div>
                <button class="btn-primary" id="analyzeBtn">Analyze <i class="fas fa-search"></i></button>
            </section>
            <section class="panel info-panel" id="resultPanel">
                <div class="result-header">
                    <h2 class="garbage-name" id="resLabel">--</h2>
                    <p class="garbage-desc" id="resDesc">--</p>
                </div>

                <div class="prob-container">
                    <h3><i class="fas fa-chart-bar"></i> Prediction Results</h3>
                    <div id="top3List"></div>
                </div>

                <div class="properties-grid">
                    <div class="prop-card inorganic">
                        <div class="icon-box"><i class="fas fa-atom"></i></div>
                        <div class="text-box"><span class="label">Material</span><span class="value" id="resType">--</span></div>
                    </div>
                    <div class="prop-card recyclable">
                        <div class="icon-box"><i class="fas fa-recycle"></i></div>
                        <div class="text-box"><span class="label">Recycle</span><span class="value" id="resRecycle">--</span></div>
                    </div>
                    <div class="prop-card flammable">
                        <div class="icon-box"><i class="fas fa-fire"></i></div>
                        <div class="text-box"><span class="label">Flammable</span><span class="value" id="resFire">--</span></div>
                    </div>
                    <div class="prop-card time">
                        <div class="icon-box"><i class="fas fa-info-circle"></i></div>
                        <div class="text-box"><span class="label">Action</span><span class="value" id="resActionShort">--</span></div>
                    </div>
                </div>

                <div class="disposal-guide">
                    <h3><i class="fas fa-trash-alt"></i> Disposal Guide</h3>
                    <ul id="resActionList">
                        <li>--</li>
                    </ul>
                </div>
            </section>
        </main>
    </div>

    <div id="infoModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2 style="margin-bottom: 15px; color: var(--primary);">About Project</h2>
            <p>- This project aims to promote environmental awareness and correct recycling habits. Upload an image to automatically identify, classify, and receive guidelines on how to process or recycle waste properly.</p>
            <p>- You can choose between two AI models: <strong>SVM</strong> (Classical Machine Learning) and <strong>CNN</strong> (Deep Learning). Due to limited server resources, the <strong>SVM</strong> model is optimized for speed and stability, whereas the <strong>CNN</strong> model is more resource-intensive.</p>
            <p>-<strong> Disclaimer:</strong> AI predictions are for reference only and may contain errors. Please verify the waste type manually before disposal.</p>
            <p>- For more information, you can view the source code at <a href="https://github.com/quocha16/Garbage_Classifier" target="_blank" style="color: var(--tag-blue-text);">Garbage Classifier</a>.</p>
                        </div>
        </div>
    </div>

    <script>
        const garbageInfo = {
            'battery': { type: 'Hazardous', recycle: 'Special', fire: 'Yes', desc: 'AA, AAA, Lithium-ion batteries contain heavy metals.', action: 'DO NOT put in normal bin. Tape ends and take to E-waste drop-off.' },
            'biological': { type: 'Organic', recycle: 'Compost', fire: 'No', desc: 'Food scraps, fruit peels, garden waste.', action: 'Use for composting or place in Organic waste bin.' },
            'cardboard': { type: 'Organic', recycle: 'High', fire: 'Yes', desc: 'Shipping boxes, packaging materials.', action: 'Flatten boxes. Keep dry. Place in Paper/Recycling bin.' },
            'clothes': { type: 'Fabric', recycle: 'Medium', fire: 'Yes', desc: 'Shirts, pants, textile scraps.', action: 'Donate if wearable. Use textile recycling services if torn.' },
            'glass': { type: 'Inorganic', recycle: 'Infinite', fire: 'No', desc: 'Bottles, jars, broken glass.', action: 'Rinse carefully. Remove lids. Place in Glass recycling bin.' },
            'metal': { type: 'Inorganic', recycle: 'High', fire: 'No', desc: 'Aluminum cans, foil, steel scraps.', action: 'Squeeze to save space. Place in Metal recycling bin or sell it for scrap if possible.' },
            'paper': { type: 'Organic', recycle: 'High', fire: 'Yes', desc: 'Newspapers, office paper, magazines.', action: 'Keep dry. Remove plastic covers/staples. Place in Paper/Recycling bin or sell as scrap paper if possible.' },
            'plastic': { type: 'Inorganic', recycle: 'Medium', fire: 'Yes', desc: 'PET bottles, containers, wrappers.', action: 'Check resin code (1-7). Rinse clean and recycle or place in Plastic bin.' },
            'shoes': { type: 'Mixed', recycle: 'Low', fire: 'Yes', desc: 'Sneakers, leather shoes, rubber footwear.', action: 'Donate to charity if good. Place in Inorganic bin if worn out.' },
            'trash': { type: 'Mixed', recycle: 'None', fire: 'Varies', desc: 'Non-recyclable waste, face mask, wrappers, styrofoam.', action: 'Place in Inorganic bin. Do not recycle.' }
        };

        const fileInput = document.getElementById('fileInput');
        const uploadArea = document.getElementById('uploadArea');
        const imagePreview = document.getElementById('imagePreview');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const mainLayout = document.getElementById('mainLayout');
        const themeBtn = document.getElementById('themeBtn');
        const topListContainer = document.getElementById('top3List');
        const htmlElement = document.documentElement;

        // --- Info Modal Logic (MỚI THÊM) ---
        const infoBtn = document.getElementById("infoBtn");
        const infoModal = document.getElementById("infoModal");
        const closeBtn = document.getElementsByClassName("close-btn")[0];

        infoBtn.onclick = function() { infoModal.style.display = "block"; }
        closeBtn.onclick = function() { infoModal.style.display = "none"; }
        window.onclick = function(event) { if (event.target == infoModal) infoModal.style.display = "none"; }
        // -----------------------------------

        // --- Theme Management ---
        const savedTheme = localStorage.getItem('theme') || 'light';
        applyTheme(savedTheme);

        function applyTheme(theme) {
            htmlElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            themeBtn.innerHTML = theme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
        }

        themeBtn.addEventListener('click', () => {
            const currentTheme = htmlElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            applyTheme(newTheme);
        });
        // -------------------------

        let selectedFile = null;

        uploadArea.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', e => { if (e.target.files[0]) handleFile(e.target.files[0]); });
        uploadArea.addEventListener('dragover', e => { e.preventDefault(); uploadArea.classList.add('drag-active'); });
        uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('drag-active'));
        uploadArea.addEventListener('drop', e => {
            e.preventDefault(); uploadArea.classList.remove('drag-active');
            if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
        });

        function handleFile(file) {
            selectedFile = file;
            const reader = new FileReader();
            reader.onload = e => {
                imagePreview.src = e.target.result;
                uploadArea.classList.add('has-image');
                mainLayout.classList.remove('has-results');
            };
            reader.readAsDataURL(file);
        }

        function updateDisplayInfo(label) {
            const labelKey = label.toLowerCase().trim();
            const info = garbageInfo[labelKey] || { type: 'Unknown', recycle: 'Unknown', fire: 'Unknown', desc: '--', action: '--' };

            document.getElementById('resLabel').textContent = label.toUpperCase();
            document.getElementById('resDesc').textContent = info.desc;
            document.getElementById('resType').textContent = info.type;
            document.getElementById('resRecycle').textContent = info.recycle;
            document.getElementById('resFire').textContent = info.fire;
            document.getElementById('resActionShort').textContent = "See Guide";
            document.getElementById('resActionList').innerHTML = `<li>${info.action}</li>`;

            document.querySelectorAll('.prob-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.label.toLowerCase() === labelKey) item.classList.add('active');
            });
        }

        analyzeBtn.addEventListener('click', () => {
            if (!selectedFile) return alert("Please select an image first!");

            //Lấy model đang được chọn
            const selectedModel = document.querySelector('input[name="ai-model"]:checked').value;

            const formData = new FormData();
            formData.append('file', selectedFile);
            //Gửi thêm tham số model_type xuống backend
            formData.append('model_type', selectedModel);

            //Cập nhật text nút bấm để người dùng biết đang chạy model nào
            const modelName = selectedModel === 'svm' ? 'SVM' : 'Neural Net';
            analyzeBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Running ${modelName}...`;
            analyzeBtn.disabled = true;

            fetch('/predict', { method: 'POST', body: formData })
                .then(res => res.json())
                .then(data => {
                    analyzeBtn.innerHTML = 'Analyze <i class="fas fa-search"></i>';
                    analyzeBtn.disabled = false;

                    if (data.error) return alert(data.error);

                    //Phần xử lý hiển thị kết quả giữ nguyên như cũ ---
                    updateDisplayInfo(data.prediction);

                    //Cập nhật danh sách top 3
                    topListContainer.innerHTML = '';
                    //Thêm dòng thông báo nhỏ model nào đã được dùng
                    const infoModel = document.createElement('div');
                    infoModel.style.marginBottom = "10px";
                    infoModel.style.fontSize = "0.8rem";
                    infoModel.style.color = "var(--text-sub)";
                    infoModel.innerHTML = `Result from: <strong>${data.model}</strong>`;
                    topListContainer.appendChild(infoModel);

                    if (data.top_3) {
                        data.top_3.forEach((item, index) => {
                            const div = document.createElement('div');
                            div.className = 'prob-item' + (index === 0 ? ' active' : '');
                            div.dataset.label = item.label; // Sửa lỗi cũ: item.label thay vì label_name

                            div.innerHTML = `
                                <div class="prob-label">
                                    <span>${item.label.toUpperCase()}</span>
                                    <span>${item.confidence}%</span>
                                </div>
                                <div class="prob-bar-bg">
                                    <div class="prob-bar-fill" style="width: ${item.confidence}%"></div>
                                </div>
                            `;

                            div.addEventListener('click', () => {
                                updateDisplayInfo(item.label);
                            });

                            topListContainer.appendChild(div);
                        });
                    }
                    mainLayout.classList.add('has-results');
                })
                .catch((err) => {
                    console.error(err);
                    analyzeBtn.disabled = false;
                    analyzeBtn.innerHTML = 'Analyze <i class="fas fa-search"></i>';
                    alert("Connection error!");
                });
        });
    </script>
</body>

</html>
